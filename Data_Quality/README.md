# Тестовое задание на позицию Data Engineer стажер
**Необходимо:**
- Развернуть бэкап базы данных на локальной машине
- Ответить на стандартный запрос в службу технической поддержки

**В качестве ответа на задание**, необходимо выслать ответное письмо, которое включает в себя:
1. Скрипт хранимой процедуры после внесения необходимых изменений;
2. Описание хода решения с развернутыми комментариями по каждому пункту.

**Запрос с службу технической поддержки:**
*1. Заказчик утверждает, что продажи с НДС по сети, по группе товаров 'Биологически активные добавки',  в июне 2017 составил 1 782 949.10 руб. Продажи шт. - 6761.10.
- Необходимо найти и устранить возможные причины расхождений.
- Пример запуска процедуры: exec sp_report_1 @date_from = '2017-06-01', @date_to = '2017-06-30', @good_group_name = N'Биологически активные добавки'
2. Необходимо добавить показатели: 
- Средняя цена закупки руб., без НДС
- Маржа руб. без НДС
- Наценка % без НДС
3. Добавить возможность фильтрации по нескольким группам товаров одновременно. На вход группы подаются через запятую в параметр @good_group_name.  
- Пример запуска процедуры: exec sp_report_1 @date_from = '2017-06-01', @date_to = '2017-06-30', @good_group_name = 'Биологически активные добавки,Косметические средства'
4. Вывести долю продаж с НДС товара, в каждом дне/магазине/группе товаров, отсортировать выборку по убыванию показателя.
Примечание. Относительно расчета - нужна доля от продаж позиции в аптеке, от продажи группы товара в этой же аптеке. Показатель нужно добавить в текущую процедуру формирования данных для отчета. *

**Состав БД**<br>
![image](https://user-images.githubusercontent.com/84066295/126966879-a4ba4495-4568-4673-8514-6e3c7ceac395.png)

**Содержимое таблиц**<br>
![image](https://user-images.githubusercontent.com/84066295/126979345-42a7a0dd-b717-4a93-b44f-17b98a709da1.png)
![image](https://user-images.githubusercontent.com/84066295/126979424-97c485e9-5683-4f16-8bf2-1a9e3d2fda86.png)
![image](https://user-images.githubusercontent.com/84066295/126979484-f584111a-75c9-4ca0-a02f-2d473d2ff0b2.png)
![image](https://user-images.githubusercontent.com/84066295/126979527-9cf05ece-098c-40b5-89fe-acf4b906368b.png)
![image](https://user-images.githubusercontent.com/84066295/126979571-43a31d1e-8173-4993-8475-def406343e7b.png)

**Реализация задания:** <br>

    -- Запускаем инициализацию процедуры. Здесь все без изменений
    SET ANSI_NULLS ON
    GO
    SET QUOTED_IDENTIFIER ON
    GO

    ALTER PROCEDURE [dbo].[sp_report_2]
      @date_from date,
      @date_to date,
      @good_group_name nvarchar(MAX)
    AS

    BEGIN

    declare @date_from_int int
    declare @date_to_int int

	
    set @date_from_int = (select top 1 did from dbo.dim_date where d = @date_from )
    set @date_to_int = (select top 1 did from dbo.dim_date where d = @date_to )

    /* 
    Постановка задачи:
    [к зад.1]: 1.1. Определить причину расхождений в количестве проданного товара.
    [к зад.1]: 1.2. Определить причину расхождений в сумме продаж в рублях.

    [к зад.2]: 2. Необходимо добавить показатели: 
    [к зад.2]:  2.1. Средняя цена закупки руб., без НДС
    [к зад.2]:  2.2. Маржа руб. без НДС
    [к зад.2]:  2.3. Наценка % без НДС

    [к зад.3]: 3.1 Добавить возможность фильтрации по нескольким группам товаров одновременно

    [к зад.4]: 4.1 Вывести долю продаж с НДС товара, в каждом дне/магазине/группе товаров, отсортировать выборку по убыванию показателя

    Примечание:
    Я решил добавить все комментарии к шагам в один итоговый запрос. Для понимания к какому заданию относится коментарий оставил боковые
    "подсказки". Однако, все равно местами запрос выглядит сумбурно. При необходимсти, отправлю решение каждого задания отдельно.

    Реализация:
    [к зад.1]: Как выяснилось, причина расхождений в сумме продаж в том что сторона заказчика считает продажи с НДС по столбцу [sale_grs],
    [к зад.1]: что правильно. В то время как наша сторона использует в расчетах [sale_net] - Продажи руб., без НДС. В запросе исправим это.
    [к зад.1]: Теперь разберем в чем причина расхождений в количестве проданных товаров. Предположительно причина в JOIN 

    [к зад.4]: Чтобы найти долю от продаж позиции в аптеке нужно сумму полученную от реализации товара поделить на общую сумму
    [к зад.4]: реализованных товаров в тот же день, в той же аптеке, и в той же группе.
    [к зад.4]: Вызовем необходимые столбцы из нашего базового запроса, так как будем использовать оконную функцию*/
    SELECT 
        [Дата],
        [Аптека],
        [Группа товара],
        [Номенклатура],
        [Продажи шт.],
        [Продажи руб., с НДС],
        [Закупка руб., с НДС],
        [Средняя цена закупки руб., без НДС], 
        [Маржа руб., без НДС],
        [Наценка %, без НДС],
    --[к зад.4]: Для рассчета общей суммы продаж передаем в OVER(PARTITION BY ... столбцы [Дата], [Аптека], [Группа товара])
    --[к зад.4]: Далее делим сумму от реализации товара на общую сумму реализованных товаров той же группы. Тем самым находим долю товара:
        [Сумма продаж руб., с НДС] / SUM([Сумма продаж руб., с НДС]) OVER(PARTITION BY [Дата], [Аптека], [Группа товара]) AS [Доля продаж товара с НДС]
    FROM (
        SELECT
            d.d as [Дата],
            s.store_name as [Аптека],
            g.group_name as [Группа товара] ,
            g.good_name as [Номенклатура],
            SUM(f.quantity) as [Продажи шт.],
        --[к зад.1]: В графах [Продажи руб., с НДС], [Закупка руб., с НДС] была допущена ошибка. Они считались по столбцам [sale_net], [cost_net]
        --[к зад.1]: не включающим НДС. Столбцы исправлены на [sale_grs] и [cost_grs].
            SUM(f.sale_grs) as [Продажи руб., с НДС],
            SUM(f.cost_grs) as [Закупка руб., с НДС],
        --[к зад.2]: Добавим показатель [Средняя цена закупки руб., без НДС]
            AVG(f.cost_net) AS [Средняя цена закупки руб., без НДС],
        --[к зад.2]: Добавим показатель [Маржа руб., без НДС]
            AVG(f.sale_net) - AVG(f.cost_net) AS [Маржа руб., без НДС],
        --[к зад.2]: Добавим показатель [Наценка %, без НДС]. Чтобы избежать ошибки деления на ноль воспользуемся CASE. Наценку на товары 
        --[к зад.2]: с закупочной ценой равной нулю будем считать как среднюю цену продажи товара с НДС.
            CASE WHEN AVG(f.cost_net) = 0 THEN AVG(f.sale_net) ELSE (AVG(f.sale_net) - AVG(f.cost_net))/AVG(f.cost_net) * 100 END AS [Наценка %, без НДС],
        --[к зад.4]: Добавим показатель, необходимый для расчета доли товара в аптеке - [Сумма продаж руб., с НДС]
            SUM(f.sale_grs) AS [Сумма продаж руб., с НДС]

        /*[к зад.1]: Начинаем джоинить таблицы. Нашей отправной точкой является таблица [dbo.fct_cheque] - так как она содержит 
        [к зад.1]: всю информацию о чеках. Т.е. точное время, количество, и id товара. Уже на данном этапе, можно найти оценить порядок проданых
        [к зад.1]: товаров за июнь 2017г. Их "грязное" количество 6763.1. (что на 2 единицы больше чем у заказчика. Запомним это)

        [к зад.1]: Текущий вывод: ошибка на нашей стороне. Скорее всего при соединении таблиц. Проверим.
         */
        FROM 
            dbo.fct_cheque AS f
        --[к зад.1]: Джоиним таблицу dbo.goods слева. Потому как если (маловероятно но все же) товара нет в таблице dbo.goods, мы потеряем его и в 
        --[к зад.1]: таблице [dbo.fct_cheque]
            JOIN dbo.dim_goods AS g ON f.good_id = g.good_id
        --[к зад.1]: Далее соединяем таблицу dbo.dim_stores чтобы вытащить номер аптеки. Джоиним тоже слева по тем же причинам. 
            LEFT JOIN dbo.dim_stores AS s ON f.store_id = s.store_id
        --[к зад.1]: Здесь, после inner join количество проданного товара уменьшается до 6646.10. Значит, какой-то аптеки нет в справочнике, 
        --[к зад.1]: из-за чего некоторые позиции не входят в джоин. Всего в справочнике [stores] 57 аптек. В июне, товарами из группы №1 торговали  
        --[к зад.1]: всего 10 уникальных аптек. При соединении этих двух таблиц остается уже 9 уникальных аптек. Что подтверждает отсутствие одной 
        --[к зад.1]: аптеки в справочнике. Ее store_id = 47.

        --[к зад.1]: Вытаскаваем информацию о датах. Для этого соединяем таблицу dbo.dim_date. Здесь проблем быть не должно
            LEFT JOIN dbo.dim_date AS d ON f.date_id = d.did 
        --[к зад.1]: Теперь вытаскаваем информацию о кассах. В таблице-справочнике [cash_register_id] - есть ошибка. Касса №7 упоминается дважды, 
        --[к зад.1]: отчего при соединении таблиц мы получаем около сотни дубликатов. Поэтому, в [cash_register_id] отберем только уникальные 
        --[к зад.1]: значения и сджоиним.
        --[к зад.1]: Помимо этого, еще отсутствует касса с индексом 10, которая использовалась в интересующий нас промежуток времени.

            LEFT JOIN (
                    SELECT 
                        DISTINCT cash_register_id,
                        cash_register_number
                    FROM dbo.dim_cash_register
                )  AS cr ON cr.cash_register_id = f.cash_register_id
        WHERE date_id BETWEEN @date_from_int AND @date_to_int
        /*[к зад.3]: Переходим к реализации многосложной фильтрации. Для этого можно воспользоваться стандартной строковой функцией STRING_SPLIT(). 
        [к зад.3]: Однако, в процессе работы, я обнаружил ту же функцию но под именем string_split() в теле базы данных. Дальнейшая  
        [к зад.3]: реализация выполняется с ее помощью
        [к зад.3]: Для того, чтобы воспользоваться функцией string_split() нужен уровень совместимости базы данных равный 130. Назначим:
        [к зад.3]: ALTER DATABASE TestTaskDB SET COMPATIBILITY_LEVEL = 130 */
            AND g.group_name IN (SELECT * FROM string_split(@good_group_name, ','))
        GROUP BY 
            d.d,
            s.store_name,
            g.group_name,
            g.good_name
        ) AS query_1
    ORDER BY 
    --[к зад.4]: Чтобы осуществить сортировку по столбцу [Доля продаж товара с НДС], сначала отсортируем таблицу по дате и номеру аптеки, 
    --[к зад.4]: а уже после по столбцу [Доля продаж товара с НДС]:
        [Дата],
        [Аптека],
        [Доля продаж товара с НДС] DESC

    END
    GO

    /* 
    [к зад.1]: Таким образом, причина расхождений в количестве проданных товаров заключалась:
    [к зад.1]:    1. В отсутствии Аптеки с id = 47 в справочной таблице [dim_stores]
    [к зад.1]:    2. В дублировании номера кассы id = 7 в таблице [dim_cash_register]
    [к зад.1]: Причина расхождений в сумме проданного в рублях, в том что наша сторона и сторона заказчика использует для расчетов разные столбцы.

    [к зад.1]: Итоговые величины за июнь 2017 по группе товаров "Биологически активные добавки":
    [к зад.1]: - Количество проданного товара: 6763.10 шт.     | у заказчика:  6761.10 шт. (разница в 2 шт.)
    [к зад.1]: - Сумма продаж с НДС по сети: 1 783 203.10 руб. | у заказчика:  1 782 949.10 руб. (разница в 254 руб.)

    Вывод: Порядок величин между нами и заказчиком совпадает. Однако, обнаружить причину расхождений по двум товарам мне не удалось. 
    Количество товаров посчитано по статичной таблице dbo.fct_cheque, где отражено фактическое количество реализованной продукции. Возможно, причина в 
    наличии нескольких дублирующихся позиций, но не имея точного времени продажи отследить это не представляется возможным. На текущем этапе я бы 
    запросил процедуру с которой работает заказчик. Возможно, причина разногласий теперь на его стороне. 
    */

    EXEC [dbo].[sp_report_2]  @date_from = '2017-06-01', @date_to = '2017-06-30', @good_group_name = N'Биологически активные добавки,Косметические средства'






